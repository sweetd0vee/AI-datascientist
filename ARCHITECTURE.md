# Архитектура проекта AI Data Scientist

## Обзор

Проект представляет собой автоматизированную систему анализа данных с использованием LLM (Large Language Models) через LangChain и Ollama. Система выполняет полный цикл анализа данных: от загрузки файлов до генерации отчетов и визуализаций.

## Архитектурные принципы

1. **Модульность** - разделение на независимые модули с четкими границами ответственности
2. **Расширяемость** - возможность добавления новых типов анализа и метрик
3. **Тестируемость** - модули легко тестируются изолированно
4. **Конфигурируемость** - настройки вынесены в отдельные файлы
5. **Разделение ответственности** - каждый модуль отвечает за свою область

## Структура проекта

```
AI-datascientist/
├── src/                          # Основной код приложения
│   ├── __init__.py
│   ├── ui/                       # Пользовательский интерфейс (Streamlit)
│   │   ├── __init__.py
│   │   ├── main.py              # Главная страница приложения
│   │   ├── components/           # Переиспользуемые UI компоненты
│   │   │   ├── __init__.py
│   │   │   ├── file_upload.py   # Компонент загрузки файлов
│   │   │   └── results_view.py  # Компонент отображения результатов
│   │   └── pages/                # Дополнительные страницы (если нужно)
│   │       └── __init__.py
│   │
│   ├── core/                     # Бизнес-логика приложения
│   │   ├── __init__.py
│   │   ├── analyzer.py           # Основной класс анализатора
│   │   ├── pipeline.py           # Конвейер обработки данных
│   │   └── orchestrator.py       # Оркестратор всего процесса анализа
│   │
│   ├── llm/                      # Работа с LLM
│   │   ├── __init__.py
│   │   ├── models.py             # Инициализация моделей Ollama
│   │   ├── prompts.py            # Шаблоны промптов
│   │   ├── chains.py             # LangChain цепочки
│   │   └── parsers.py            # Парсеры ответов LLM
│   │
│   ├── data/                     # Обработка данных
│   │   ├── __init__.py
│   │   ├── loader.py             # Загрузка файлов (CSV, Excel)
│   │   ├── preprocessor.py       # Предобработка данных
│   │   ├── metrics.py            # Расчет метрик
│   │   └── visualizer.py         # Генерация визуализаций
│   │
│   └── utils/                    # Вспомогательные утилиты
│       ├── __init__.py
│       ├── code_executor.py      # Безопасное выполнение кода
│       ├── type_converter.py     # Конвертация типов данных
│       ├── file_handler.py       # Работа с файлами
│       └── logger.py             # Настройка логирования
│
├── config/                       # Конфигурационные файлы
│   ├── __init__.py
│   ├── settings.py               # Основные настройки
│   ├── prompts_config.py         # Конфигурация промптов
│   └── models_config.py          # Конфигурация моделей LLM
│
├── tests/                        # Тесты
│   ├── __init__.py
│   ├── unit/                     # Юнит-тесты
│   │   ├── test_data_loader.py
│   │   ├── test_preprocessor.py
│   │   └── test_metrics.py
│   ├── integration/              # Интеграционные тесты
│   │   └── test_pipeline.py
│   └── fixtures/                 # Тестовые данные
│       └── sample_data.csv
│
├── scripts/                      # Вспомогательные скрипты
│   ├── setup_env.sh             # Скрипт настройки окружения
│   └── run_tests.sh             # Скрипт запуска тестов
│
├── docs/                         # Документация
│   ├── architecture.md          # Этот файл
│   ├── api.md                   # API документация
│   └── user_guide.md            # Руководство пользователя
│
├── .env.example                  # Пример файла с переменными окружения
├── .gitignore                    # Игнорируемые файлы Git
├── requirements.txt              # Зависимости Python
├── README.md                     # Основная документация проекта
└── setup.py                      # Установка пакета (опционально)
```

## Описание модулей

### 1. UI Layer (`src/ui/`)

**Ответственность**: Пользовательский интерфейс на Streamlit

- **main.py**: Главная точка входа приложения, координация UI компонентов
- **components/**: Переиспользуемые UI компоненты
  - `file_upload.py`: Загрузка и валидация файлов
  - `results_view.py`: Отображение результатов анализа

**Зависимости**: `core`, `data`

### 2. Core Layer (`src/core/`)

**Ответственность**: Бизнес-логика и оркестрация процесса анализа

- **analyzer.py**: Основной класс анализатора данных
- **pipeline.py**: Конвейер обработки данных (паттерн Pipeline)
- **orchestrator.py**: Координация всех этапов анализа

**Зависимости**: `llm`, `data`, `utils`

### 3. LLM Layer (`src/llm/`)

**Ответственность**: Интеграция с языковыми моделями

- **models.py**: Инициализация и управление моделями Ollama
- **prompts.py**: Шаблоны промптов для разных задач
- **chains.py**: LangChain цепочки для генерации кода и анализа
- **parsers.py**: Парсинг структурированных ответов от LLM

**Зависимости**: `langchain`, `ollama`

### 4. Data Layer (`src/data/`)

**Ответственность**: Обработка и анализ данных

- **loader.py**: Загрузка данных из различных форматов
- **preprocessor.py**: Предобработка (типы данных, пропуски, даты)
- **metrics.py**: Расчет статистических метрик
- **visualizer.py**: Генерация кода визуализации и выполнение

**Зависимости**: `pandas`, `numpy`, `matplotlib`, `seaborn`

### 5. Utils Layer (`src/utils/`)

**Ответственность**: Вспомогательные функции и утилиты

- **code_executor.py**: Безопасное выполнение Python кода через PythonREPL
- **type_converter.py**: Конвертация numpy/pandas типов в стандартные Python типы
- **file_handler.py**: Работа с файловой системой (сохранение отчетов, графиков)
- **logger.py**: Настройка системы логирования

**Зависимости**: Минимальные, базовые библиотеки Python

### 6. Config Layer (`config/`)

**Ответственность**: Конфигурация приложения

- **settings.py**: Основные настройки (пути, параметры)
- **prompts_config.py**: Конфигурация промптов (можно вынести в YAML/JSON)
- **models_config.py**: Настройки моделей LLM (температура, модели и т.д.)

## Поток данных

```
1. Пользователь загружает файл через UI
   ↓
2. UI → Data Loader: загрузка и валидация файла
   ↓
3. UI → Core Orchestrator: запуск анализа
   ↓
4. Orchestrator → LLM: анализ структуры данных
   ↓
5. Orchestrator → Data Preprocessor: предобработка данных
   ↓
6. Orchestrator → LLM: генерация плана метрик
   ↓
7. Orchestrator → LLM: генерация кода расчета метрик
   ↓
8. Orchestrator → Utils Code Executor: выполнение кода расчета
   ↓
9. Orchestrator → LLM: анализ результатов метрик
   ↓
10. Orchestrator → LLM: генерация кода визуализации
   ↓
11. Orchestrator → Utils Code Executor: выполнение кода визуализации
   ↓
12. Orchestrator → LLM: генерация итогового отчета
   ↓
13. Orchestrator → Utils File Handler: сохранение результатов
   ↓
14. Orchestrator → UI: отображение результатов пользователю
```

## Основные паттерны проектирования

1. **Pipeline Pattern**: Конвейер обработки данных
2. **Strategy Pattern**: Разные стратегии анализа для разных типов данных
3. **Factory Pattern**: Создание различных типов анализаторов
4. **Template Method**: Шаблонный метод для этапов анализа
5. **Dependency Injection**: Внедрение зависимостей через конструкторы

## Конфигурация

### Переменные окружения (.env)
```
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL_ANALYST=t-pro-it-1.0-q8_0.gguf:latest
OLLAMA_MODEL_CODER=qwen3-coder:latest
OLLAMA_TEMPERATURE_ANALYST=0.55
OLLAMA_TEMPERATURE_CODER=0.2
LOG_LEVEL=INFO
OUTPUT_DIR=./outputs
```

### Конфигурационные файлы
- YAML/JSON для промптов (опционально)
- Python файлы для настроек приложения

## Тестирование

- **Unit тесты**: Тестирование отдельных модулей изолированно
- **Integration тесты**: Тестирование взаимодействия модулей
- **E2E тесты**: Тестирование полного потока через UI

## Расширяемость

### Добавление новых типов метрик
1. Расширить `data/metrics.py` новыми функциями расчета
2. Обновить промпт в `llm/prompts.py`
3. Добавить парсинг в `llm/parsers.py`

### Добавление новых форматов данных
1. Расширить `data/loader.py` поддержкой нового формата
2. Обновить валидацию в `ui/components/file_upload.py`

### Добавление новых типов визуализаций
1. Расширить промпт визуализации в `llm/prompts.py`
2. Обновить `data/visualizer.py` при необходимости

## Безопасность

1. **Выполнение кода**: Использование изолированной среды PythonREPL
2. **Валидация входных данных**: Проверка всех пользовательских входов
3. **Обработка ошибок**: Graceful degradation при ошибках LLM
4. **Логирование**: Детальное логирование для отладки

## Производительность

1. **Кэширование**: Кэширование моделей LLM через `@st.cache_resource`
2. **Ленивая загрузка**: Загрузка данных только при необходимости
3. **Асинхронность**: Возможность асинхронных вызовов LLM (будущее)

## Мониторинг и логирование

- Структурированное логирование через `logging`
- Отслеживание времени выполнения этапов
- Метрики использования LLM

