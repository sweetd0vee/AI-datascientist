import os
import streamlit as st
import pandas as pd
from io import BytesIO, StringIO
import json
import logging
from dateutil.parser import parse
import numpy as np
import re
import ast
import textwrap

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

from langchain_community.llms import Ollama
from langchain_core.prompts import PromptTemplate
from langchain.chains import LLMChain
from langchain_experimental.utilities import PythonREPL

# --- –ü–†–û–ú–¢–´ ---
struct_analyze = """
                –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ:
                {file_info}
                –û–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ –∏ –∏—Ö —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (—á–∏—Å–ª–æ–≤–æ–π, –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–π, –¥–∞—Ç–∞, –±—É–ª–µ–≤—ã–π –∏ —Ç.–¥.).
                –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ —É–¥–µ–ª–∏—Ç–µ —Å—Ç–æ–ª–±—Ü–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–∞—Ç—É/–≤—Ä–µ–º—è.

                –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –∞–Ω–∞–ª–∏–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—è —à–∞–±–ª–æ–Ω—É –Ω–∏–∂–µ. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏—è –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ:
                ---COLUMNS_START---
                –°—Ç–æ–ª–±–µ—Ü: –∏–º—è_—Å—Ç–æ–ª–±—Ü–∞_1
                –¢–∏–ø: –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π_—Ç–∏–ø_–¥–∞–Ω–Ω—ã—Ö
                –û–ø–∏—Å–∞–Ω–∏–µ: –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                
                –°—Ç–æ–ª–±–µ—Ü: –∏–º—è_—Å—Ç–æ–ª–±—Ü–∞_2
                –¢–∏–ø: –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π_—Ç–∏–ø_–¥–∞–Ω–Ω—ã—Ö
                –û–ø–∏—Å–∞–Ω–∏–µ: –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                ---COLUMNS_END---
                ---DATETIME_CANDIDATES_START---
                –∏–º—è_—Å—Ç–æ–ª–±—Ü–∞_1, –∏–º—è_—Å—Ç–æ–ª–±—Ü–∞_3
                ---DATETIME_CANDIDATES_END---

                –ü—Ä–∏–º–µ—Ä (–Ω–µ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å):
                ---COLUMNS_START---
                –°—Ç–æ–ª–±–µ—Ü: PassengerId
                –¢–∏–ø: numerical (integer)
                –û–ø–∏—Å–∞–Ω–∏–µ: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–∞—Å—Å–∞–∂–∏—Ä–∞

                –°—Ç–æ–ª–±–µ—Ü: Name
                –¢–∏–ø: textual (object)
                –û–ø–∏—Å–∞–Ω–∏–µ: –ò–º—è –ø–∞—Å—Å–∞–∂–∏—Ä–∞
                ---COLUMNS_END---
                ---DATETIME_CANDIDATES_START---
                
                ---DATETIME_CANDIDATES_END---
                """ #–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

m_plan =  """
                –ù–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:
                {data_structure}
                –ü—Ä–µ–¥–ª–æ–∂–∏ —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö. –£—á—Ç–∏ Best Practices –ø–æ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö:

                - –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤:
                    * –ú–µ—Ä—ã —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏: mean (—Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ), median (–º–µ–¥–∏–∞–Ω–∞), mode (–Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–µ–µ—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ)
                    * –ú–µ—Ä—ã –∏–∑–º–µ–Ω—á–∏–≤–æ—Å—Ç–∏: std (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ), var (–¥–∏—Å–ø–µ—Ä—Å–∏—è), mad (—Å—Ä–µ–¥–Ω–µ–µ –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ)
                    * –ú–µ—Ä—ã —Ñ–æ—Ä–º—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: skew (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∞—Å–∏–º–º–µ—Ç—Ä–∏–∏), kurtosis (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —ç–∫—Å—Ü–µ—Å—Å–∞)
                    * –ö–≤–∞–Ω—Ç–∏–ª–∏: min (–º–∏–Ω–∏–º—É–º), max (–º–∞–∫—Å–∏–º—É–º), quantile_25 (1-–π –∫–≤–∞—Ä—Ç–∏–ª—å, 25%), quantile_75 (3-–π –∫–≤–∞—Ä—Ç–∏–ª—å, 75%), quantile_90 (90-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å), quantile_95 (95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å)
                    * –î—Ä—É–≥–∏–µ: count (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π), iqr (–∏–Ω—Ç–µ—Ä–∫–≤–∞—Ä—Ç–∏–ª—å–Ω—ã–π —Ä–∞–∑–º–∞—Ö)

                - –î–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤:
                    * count (–æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
                    * nunique (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
                    * mode (–Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è)
                    * mode_count (—á–∞—Å—Ç–æ—Ç–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ) —Å–∞–º–æ–π —á–∞—Å—Ç–æ—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
                    * mode_rel_freq (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ (–¥–æ–ª—è) —Å–∞–º–æ–π —á–∞—Å—Ç–æ—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)

                - –î–ª—è –¥–∞—Ç (datetime):
                    * count (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
                    * min_date (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è/—Ä–∞–Ω–Ω—è—è –¥–∞—Ç–∞)
                    * max_date (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è/–ø–æ–∑–¥–Ω—è—è –¥–∞—Ç–∞)
                    * date_range_days (–æ–±—â–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –≤ –¥–Ω—è—Ö, —Ä–∞–∑–Ω–∏—Ü–∞ max_date - min_date –≤ –¥–Ω—è—Ö)
                    * unique_dates (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–∞—Ç/–¥–Ω–µ–π)
                    * dates_per_month (—Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ –º–µ—Å—è—Ü, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)

                –í–µ—Ä–Ω–∏ —Å–ø–∏—Å–æ–∫ –º–µ—Ç—Ä–∏–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—è —à–∞–±–ª–æ–Ω—É –Ω–∏–∂–µ. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏—è –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ:
                ---METRICS_START---
                –°—Ç–æ–ª–±–µ—Ü: —Å—Ç–æ–ª–±–µ—Ü_1
                –ú–µ—Ç—Ä–∏–∫–∏: –º–µ—Ç—Ä–∏–∫–∞1, –º–µ—Ç—Ä–∏–∫–∞2, –º–µ—Ç—Ä–∏–∫–∞3

                –°—Ç–æ–ª–±–µ—Ü: —Å—Ç–æ–ª–±–µ—Ü_2
                –ú–µ—Ç—Ä–∏–∫–∏: –º–µ—Ç—Ä–∏–∫–∞4, –º–µ—Ç—Ä–∏–∫–∞5
                ---METRICS_END---

                –ü—Ä–∏–º–µ—Ä (–Ω–µ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å):
                ---METRICS_START---
                –°—Ç–æ–ª–±–µ—Ü: Age
                –ú–µ—Ç—Ä–∏–∫–∏: count, mean, median, mode, std, var, min, max, quantile_25, quantile_75, skew, kurtosis, mad, iqr

                –°—Ç–æ–ª–±–µ—Ü: Sex
                –ú–µ—Ç—Ä–∏–∫–∏: count, nunique, mode, mode_count, mode_rel_freq

                –°—Ç–æ–ª–±–µ—Ü: SignupDate
                –ú–µ—Ç—Ä–∏–∫–∏: count, min_date, max_date, date_range_days, unique_dates
                ---METRICS_END---
                """ #—Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –º–µ—Ç—Ä–∏–∫

# data_analyze = """
# –ù–∏–∂–µ –ø—Ä–≤–µ–¥–µ–Ω—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞:
# {metrics_results_raw}

# –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —ç—Ç–∏—Ö –º–µ—Ç—Ä–∏–∫ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

# üìä –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ê–ù–ê–õ–ò–ó–£:
# - –î–ª—è –ö–ê–ñ–î–û–ì–û —Å—Ç–æ–ª–±—Ü–∞ –¥–∞–π –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
# - –û–ø–∏—à–∏ –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (—Å—Ä–µ–¥–Ω–µ–µ, –º–µ–¥–∏–∞–Ω–∞, –º–æ–¥–∞, std, –º–∏–Ω/–º–∞–∫—Å)
# - –í—ã—è–≤–∏ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏, –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
# - –û—Ç–º–µ—Ç—å –∞–Ω–æ–º–∞–ª–∏–∏, –≤—ã–±—Ä–æ—Å—ã –∏ –Ω–µ–æ–±—ã—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
# - –°—Ä–∞–≤–Ω–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ–∂–¥—É —Å—Ç–æ–ª–±—Ü–∞–º–∏ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
# - –°–¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
# - –£–∫–∞–∂–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–∞–Ω–Ω—ã–º–∏ (–ø—Ä–æ–ø—É—Å–∫–∏, –¥—É–±–ª–∏–∫–∞—Ç—ã, –æ—à–∏–±–∫–∏)
# - –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç–µ —Å –∫–∞–∂–¥—ã–º —Å—Ç–æ–ª–±—Ü–æ–º
# - –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –≥–∏–ø–æ—Ç–µ–∑—ã –∏ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö

# üìå –°–¢–†–£–ö–¢–£–†–ê –ê–ù–ê–õ–ò–ó–ê:
# 1. –û–±—â–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞
# 2. –ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏:
#    - –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –∏—Ö –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
#    - –§–æ—Ä–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
#    - –ê–Ω–æ–º–∞–ª–∏–∏ –∏ –≤—ã–±—Ä–æ—Å—ã
#    - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
# 3. –í–æ–∑–º–æ–∂–Ω—ã–µ –º–µ–∂—Å—Ç–æ–ª–±—Ü–æ–≤—ã–µ —Å–≤—è–∑–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
# 4. –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

# –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –≤ —Ü–∏—Ñ—Ä–∞—Ö –∏ –ø—Ä–∏–º–µ—Ä–∞—Ö.
# """
# data_analyze = """
# –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞:
# {metrics_results_raw}

# –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–≤–µ—Å—Ç–∏ –ì–õ–£–ë–û–ö–ò–ô, –ò–°–ß–ï–†–ü–´–í–ê–Æ–©–ò–ô –∏ –°–û–î–ï–†–ñ–ê–¢–ï–õ–¨–ù–´–ô –∞–Ω–∞–ª–∏–∑ —ç—Ç–∏—Ö –º–µ—Ç—Ä–∏–∫ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

# –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏ —Å–ª–µ–¥—É—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
# - –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (—Å—Ä–µ–¥–Ω–µ–µ, –º–µ–¥–∏–∞–Ω–∞, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ), —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ, —Å–∫–æ—à–µ–Ω–Ω–æ–µ, –Ω–∞–ª–∏—á–∏–µ –≤—ã–±—Ä–æ—Å–æ–≤)
# - –¢–µ–Ω–¥–µ–Ω—Ü–∏–∏ –∏ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏, –∞–Ω–æ–º–∞–ª–∏–∏ –∏ –Ω–µ–æ–±—ã—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
# - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–∞–Ω–Ω—ã–º–∏ (–ø—Ä–æ–ø—É—Å–∫–∏, –¥—É–±–ª–∏–∫–∞—Ç—ã, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
# - –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏, –≥–∏–ø–æ—Ç–µ–∑—ã –∏ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –æ –ø—Ä–∏—á–∏–Ω–∞—Ö –Ω–∞–±–ª—é–¥–∞–µ–º—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

# ‚ö†Ô∏è –í–ê–ñ–ù–û:
# - –ù–µ –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—Å—ã–≤–∞–π —á–∏—Å–ª–∞ - –æ–±—ä—è—Å–Ω—è–π –∏—Ö —Å–º—ã—Å–ª
# - –î–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã–≤–æ–¥–∞—Ö
# - –£–∫–∞–∑—ã–≤–∞–π –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
# - –§–æ—Ä–º—É–ª–∏—Ä—É–π –≥–∏–ø–æ—Ç–µ–∑—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

# –û—Ç—á–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–õ–ï–ó–ù–´–ú –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
# """
data_analyze =  """
                –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞:
                {metrics_results_raw}

                –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —ç—Ç–∏—Ö –º–µ—Ç—Ä–∏–∫ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ü–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞–∂–¥—ã–π —Å—Ç–æ–ª–±–µ—Ü, —É—á–∏—Ç—ã–≤–∞—è –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏. –û–±—ã—á–Ω–æ –æ–±—ä–µ–º –æ—Ç—á–µ—Ç–∞ - 40-50 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
                """ #–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫ –Ω–∞ –º–µ—Ç—Ä–∏–∫–∞—Ö

final_rep = """

–ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞:
{analysis_summary}
—Å–æ—Å—Ç–∞–≤—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –ª–æ–≥–∏—á–µ—Å–∫–∏ –≤—ã—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∏ —Å—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏ –≤—ã–¥–µ—Ä–∂–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—Å–µ—Å—Ç–æ—Ä–æ–Ω–Ω–µ –æ—Ü–µ–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö, –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏ –∏ –∞–Ω–æ–º–∞–ª–∏–∏. –û—Ç—á—ë—Ç –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å –æ–±—â—É—é —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, –∞–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ª–Ω–æ—Ç—ã –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º, –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º (–ø—Ä–æ–ø—É—Å–∫–∏, –≤—ã–±—Ä–æ—Å—ã, –¥—É–±–ª–∏–∫–∞—Ç—ã, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã), –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–±–ª—é–¥–∞–µ–º—ã—Ö –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–µ–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π, –∞ —Ç–∞–∫–∂–µ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ‚Äî –≤ —Ç–æ–º —á–∏—Å–ª–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–≥–ª—É–±–ª–µ–Ω–∏—è. –¢–æ–Ω –∏–∑–ª–æ–∂–µ–Ω–∏—è ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π, –ø–æ–¥–∞—á–∞ ‚Äî –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è, —Å –ø–ª–∞–≤–Ω—ã–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏.
"""
# -----------------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# -----------------------------------------
st.set_page_config(page_title="–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å LangChain", layout="wide")
st.title("üìä –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö (CSV/Excel)")

# -----------------------------------------
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π Ollama
# -----------------------------------------
@st.cache_resource
def get_llms():
    try:
        llm_analyst = Ollama(model="t-pro-it-1.0-q8_0.gguf:latest", temperature=0.55) # –°–ª–µ–≥–∫–∞ –ø–æ–Ω–∏–∑–∏–ª temp –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        llm_coder = Ollama(model="qwen3-coder:latest", temperature=0.2)
        return llm_analyst, llm_coder
    except Exception as e:
        st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Ollama. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω –∏ –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. {e}")
        st.stop()

llm_analyst, llm_coder = get_llms()
# Python REPL
repl = PythonREPL()

# -----------------------------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# -----------------------------------------
# --- –î–û–ë–ê–í–õ–ï–ù–ò–ï: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–¥–∞ –∏–∑ Markdown ---
def extract_python_code(markdown_text):
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç Python-–∫–æ–¥ –∏–∑ Markdown-–±–ª–æ–∫–∞, –∑–∞–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –≤ ```python ... ```.
    –ï—Å–ª–∏ –±–ª–æ–∫–æ–≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–µ—Ä–≤–æ–≥–æ.
    –ï—Å–ª–∏ –±–ª–æ–∫–æ–≤ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç.
    """
    if not isinstance(markdown_text, str):
        return str(markdown_text)
    # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ ```python ... ```
    pattern = r"```(?:python|Python)\s*(.*?)\s*```"
    match = re.search(pattern, markdown_text, re.DOTALL)
    if match:
        code = match.group(1)
        return code.strip()
    else:
        # –ï—Å–ª–∏ –±–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω, —É–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è ```
        cleaned_text = re.sub(r"```.*?\n", "", markdown_text)
        cleaned_text = re.sub(r"```", "", cleaned_text)
        return cleaned_text.strip()
# --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---

# –ü–ï–†–ï–ü–ò–°–ê–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è convert_numpy_types –ë–ï–ó –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è .item()
def convert_numpy_types(obj):
    """
    –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –æ–±—ä–µ–∫—Ç—ã numpy, pandas –∏ –¥—Ä—É–≥–∏—Ö —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Ç–∏–ø–æ–≤ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–∏–ø—ã Python,
    –ø—Ä–∏–≥–æ–¥–Ω—ã–µ –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ JSON. –ò–°–ö–õ–Æ–ß–ï–ù–ê –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å AttributeError –æ—Ç .item().
    """
    if isinstance(obj, dict):
        new_dict = {}
        for k, v in obj.items():
            if isinstance(k, (np.integer, np.floating)):
                try:
                    new_key = k.item()
                except (AttributeError, ValueError):
                    new_key = str(k)
            elif isinstance(k, (pd.Timestamp, pd.Timedelta)) or hasattr(k, 'isoformat'):
                try:
                    new_key = k.isoformat()
                except Exception:
                    new_key = str(k)
            elif not isinstance(k, (str, int, float, bool)) or k is None:
                new_key = str(k)
            else:
                new_key = k
            new_dict[new_key] = convert_numpy_types(v)
        return new_dict
    if isinstance(obj, list):
        return [convert_numpy_types(item) for item in obj]
    if isinstance(obj, np.integer):
        return int(obj)
    if isinstance(obj, np.floating):
        if np.isnan(obj) or np.isinf(obj):
             return str(obj)
        return float(obj)
    if isinstance(obj, np.bool_):
        return bool(obj)
    if isinstance(obj, np.str_):
        return str(obj)
    if isinstance(obj, np.ndarray):
        try:
            if obj.ndim == 0:
                return convert_numpy_types(obj.item())
            return obj.tolist()
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å np.ndarray –≤ list: {e}. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ str.")
            return str(obj)
    if isinstance(obj, (pd.Timestamp, pd.Timedelta)):
        try:
            return obj.isoformat()
        except Exception:
            return str(obj)
    if hasattr(obj, 'isoformat'):
        try:
            return obj.isoformat()
        except Exception:
            return str(obj)
    return obj

# --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ---
def parse_struct_analyze_response(response_text):
    """
    –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –¥–∞–Ω–Ω—ã—Ö.
    """
    logger.debug(f"–ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏: {repr(response_text[:300])}...")
    
    parsed_data = {"columns": [], "datetime_candidates": []}
    
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–ª–æ–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
    columns_match = re.search(r"---COLUMNS_START---(.*?)---COLUMNS_END---", response_text, re.DOTALL)
    if columns_match:
        columns_text = columns_match.group(1).strip()
        # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –±–ª–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
        column_blocks = re.split(r'\n\s*\n', columns_text)
        for block in column_blocks:
            if not block.strip():
                continue
            lines = block.strip().split('\n')
            col_info = {}
            for line in lines:
                if line.startswith("–°—Ç–æ–ª–±–µ—Ü:"):
                    col_info["name"] = line[len("–°—Ç–æ–ª–±–µ—Ü:"):].strip()
                elif line.startswith("–¢–∏–ø:"):
                    col_info["type"] = line[len("–¢–∏–ø:"):].strip()
                elif line.startswith("–û–ø–∏—Å–∞–Ω–∏–µ:"):
                    col_info["description"] = line[len("–û–ø–∏—Å–∞–Ω–∏–µ:"):].strip()
            if col_info:
                parsed_data["columns"].append(col_info)
    else:
        logger.warning("–ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ ---COLUMNS_START---...---COLUMNS_END---")
        st.warning("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ –æ–ø–∏—Å–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ LLM.")
        return {}

    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–ª–æ–∫–∞ datetime –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    datetime_match = re.search(r"---DATETIME_CANDIDATES_START---(.*?)---DATETIME_CANDIDATES_END---", response_text, re.DOTALL)
    if datetime_match:
        datetime_text = datetime_match.group(1).strip()
        if datetime_text:
            parsed_data["datetime_candidates"] = [name.strip() for name in datetime_text.split(',') if name.strip()]
    else:
        logger.warning("–ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ ---DATETIME_CANDIDATES_START---...---DATETIME_CANDIDATES_END---")
        # –≠—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, —Å–ø–∏—Å–æ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
        
    logger.info("–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏.")
    logger.debug(f"–†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {parsed_data}")
    return parsed_data
# --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –§–£–ù–ö–¶–ò–ò ---

# --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø–ª–∞–Ω–∞ –º–µ—Ç—Ä–∏–∫ ---
def parse_metrics_plan_response(response_text):
    """
    –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM –ø–æ –ø–ª–∞–Ω—É –º–µ—Ç—Ä–∏–∫.
    """
    logger.debug(f"–ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–ª–∞–Ω–∞ –º–µ—Ç—Ä–∏–∫ –∏–∑ —Å—Ç—Ä–æ–∫–∏: {repr(response_text[:300])}...")
    
    parsed_data = {}
    
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–ª–æ–∫–∞ –º–µ—Ç—Ä–∏–∫
    metrics_match = re.search(r"---METRICS_START---(.*?)---METRICS_END---", response_text, re.DOTALL)
    if metrics_match:
        metrics_text = metrics_match.group(1).strip()
        # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –±–ª–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
        column_blocks = re.split(r'\n\s*\n', metrics_text)
        for block in column_blocks:
            if not block.strip():
                continue
            lines = block.strip().split('\n')
            col_name = None
            metrics_list = []
            for line in lines:
                if line.startswith("–°—Ç–æ–ª–±–µ—Ü:"):
                    col_name = line[len("–°—Ç–æ–ª–±–µ—Ü:"):].strip()
                elif line.startswith("–ú–µ—Ç—Ä–∏–∫–∏:"):
                    metrics_str = line[len("–ú–µ—Ç—Ä–∏–∫–∏:"):].strip()
                    metrics_list = [m.strip() for m in metrics_str.split(',') if m.strip()]
            
            if col_name:
                parsed_data[col_name] = metrics_list
    else:
        logger.warning("–ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ ---METRICS_START---...---METRICS_END---")
        st.warning("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ –ø–ª–∞–Ω–∞ –º–µ—Ç—Ä–∏–∫ –≤ –æ—Ç–≤–µ—Ç–µ LLM.")
        return {}

    logger.info("–ü–ª–∞–Ω –º–µ—Ç—Ä–∏–∫ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω –∏–∑ —Å—Ç—Ä–æ–∫–∏.")
    logger.debug(f"–†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {parsed_data}")
    return parsed_data
# --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –§–£–ù–ö–¶–ò–ò ---


# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –∏ –î–û–ü–û–õ–ù–ï–ù–ò–ï: safe_code_execution —Å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π df ---
def static_code_analysis(code_str, context_name=""):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–¥–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π.
    """
    warnings = []
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —Å –ø–æ–º–æ—â—å—é ast
        ast.parse(code_str)
        logger.info(f"–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ({context_name}): –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.")
    except SyntaxError as e:
        warnings.append(f"‚ùå –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        logger.warning(f"–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ({context_name}): –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        return warnings # –î–∞–ª—å–Ω–µ–π—à–∏–π –∞–Ω–∞–ª–∏–∑ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–µ–Ω –ø—Ä–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
    lines = code_str.split('\n')
    for i, line in enumerate(lines):
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ resample –±–µ–∑ —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞
        if '.resample(' in line and not ('set_index(' in code_str and code_str.find('set_index(') < code_str.find('.resample(')):
            if line.strip().startswith('df.') or '.resample(' in line.split('=')[-1]:
                 warnings.append(
                    f"‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Å—Ç—Ä–æ–∫–µ {i+1}: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 'resample' –±–µ–∑ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–µ–≥–æ 'set_index' –Ω–∞ datetime-—Å—Ç–æ–ª–±—Ü–µ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å TypeError. "
                    f"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–Ω–¥–µ–∫—Å —è–≤–ª—è–µ—Ç—Å—è DatetimeIndex –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ df.set_index('date_column').resample(...). "
                    f"–°—Ç—Ä–æ–∫–∞: {line.strip()}"
                )
            logger.warning(f"–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ({context_name}): –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ resample –≤ —Å—Ç—Ä–æ–∫–µ {i+1}: {line.strip()}")

    if not warnings:
        logger.info(f"–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ({context_name}): –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã.")
    else:
        logger.warning(f"–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ({context_name}): –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã: {warnings}")
    return warnings

def load_df_from_state():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç df –∏–∑ st.session_state –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É –ø—É—Ç–∏ –∏–ª–∏ —Ñ–∞–π–ª—É."""
    if "uploaded_file" in st.session_state and st.session_state["uploaded_file"] is not None:
        # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        uploaded_file = st.session_state["uploaded_file"]
        try:
            if uploaded_file.name.endswith(".csv"):
                try:
                    df = pd.read_csv(uploaded_file, encoding='utf-8')
                except UnicodeDecodeError:
                    try:
                        uploaded_file.seek(0)
                        df = pd.read_csv(uploaded_file, encoding='latin1')
                    except:
                        uploaded_file.seek(0)
                        df = pd.read_csv(uploaded_file, encoding='cp1251')
            elif uploaded_file.name.endswith(".xlsx"):
                df = pd.read_excel(uploaded_file)
            else:
                raise ValueError("–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.")
            return df
        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: {e}")
            return None
    elif "file_path" in st.session_state and st.session_state["file_path"]:
        # –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ –ø—É—Ç–∏
        file_path = st.session_state["file_path"]
        try:
            if file_path.endswith(".csv"):
                try:
                    df = pd.read_csv(file_path, encoding='utf-8')
                except UnicodeDecodeError:
                    try:
                        df = pd.read_csv(file_path, encoding='latin1')
                    except:
                        df = pd.read_csv(file_path, encoding='cp1251')
            elif file_path.endswith(".xlsx"):
                df = pd.read_excel(file_path)
            else:
                raise ValueError("–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.")
            return df
        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –ø–æ –ø—É—Ç–∏ {file_path}: {e}")
            return None
    else:
        st.error("‚ùå –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.")
        return None

# --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞ –æ—Ç LLM ---
def preprocess_dates_based_on_llm(df: pd.DataFrame, datetime_columns: list) -> pd.DataFrame:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã –≤ datetime.
    Args:
        df (pd.DataFrame): –ò—Å—Ö–æ–¥–Ω—ã–π DataFrame.
        datetime_columns (list): –°–ø–∏—Å–æ–∫ –∏–º–µ–Ω —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è.
    Returns:
        pd.DataFrame: DataFrame —Å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–º–∏ —Å—Ç–æ–ª–±—Ü–∞–º–∏.
    """
    df_processed = df.copy()
    successfully_converted = []
    if not datetime_columns:
        logger.info("–°–ø–∏—Å–æ–∫ datetime-—Å—Ç–æ–ª–±—Ü–æ–≤ –ø—É—Å—Ç. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
        st.info("LLM –Ω–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª–∞ —Å—Ç–æ–ª–±—Ü—ã —Å –¥–∞—Ç–∞–º–∏ –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è.")
        return df_processed

    logger.info(f"–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞—Ç –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤: {datetime_columns}")
    st.info(f"LLM –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã —Å –¥–∞—Ç–∞–º–∏: {', '.join(datetime_columns)}. –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ...")

    for col in datetime_columns:
        if col not in df_processed.columns:
             logger.warning(f"–°—Ç–æ–ª–±–µ—Ü '{col}', —É–∫–∞–∑–∞–Ω–Ω—ã–π LLM –∫–∞–∫ datetime, –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DataFrame.")
             st.warning(f"–°—Ç–æ–ª–±–µ—Ü '{col}', —É–∫–∞–∑–∞–Ω–Ω—ã–π –∫–∞–∫ datetime, –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∞–Ω–Ω—ã—Ö.")
             continue
        try:
            logger.debug(f"–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ '{col}'...")
            df_processed[col] = pd.to_datetime(
                df_processed[col],
                # infer_datetime_format=True, # –ú–æ–∂–µ—Ç –±—ã—Ç—å deprecated
                errors='coerce' # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ NaT
            )
            successfully_converted.append(col)
            logger.info(f"‚úÖ –°—Ç–æ–ª–±–µ—Ü '{col}' —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç datetime64[ns].")
            st.success(f"‚úÖ –°—Ç–æ–ª–±–µ—Ü '{col}' —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ datetime.")
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü '{col}' –≤ datetime: {e}")
            st.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü '{col}' –≤ datetime: {e}")

    if successfully_converted:
        success_msg = f"–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã –≤ datetime: {', '.join(successfully_converted)}"
        logger.info(success_msg)
        st.success(success_msg)
    else:
        logger.info("–ù–∏ –æ–¥–∏–Ω –∏–∑ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ –Ω–µ –±—ã–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω.")
        st.info("–£–∫–∞–∑–∞–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã –Ω–µ –±—ã–ª–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω—ã –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫.")

    return df_processed

# --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º ---
def handle_missing_values_before_analysis(df: pd.DataFrame, metrics_plan_dict: dict) -> pd.DataFrame:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ DataFrame –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º/–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π.
    –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ —Å—Ç–æ–ª–±—Ü–∞–º, —É–ø–æ–º—è–Ω—É—Ç—ã–º –≤ metrics_plan_dict.

    Args:
        df (pd.DataFrame): –ò—Å—Ö–æ–¥–Ω—ã–π DataFrame.
        metrics_plan_dict (dict): –°–ª–æ–≤–∞—Ä—å {—Å—Ç–æ–ª–±–µ—Ü: [–º–µ—Ç—Ä–∏–∫–∏]} –æ—Ç LLM.

    Returns:
        pd.DataFrame: DataFrame —Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–ø—É—Å–∫–∞–º–∏.
    """
    if not metrics_plan_dict:
        logger.info("–ü–ª–∞–Ω –º–µ—Ç—Ä–∏–∫ –ø—É—Å—Ç. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
        return df.copy()

    df_handled = df.copy()
    columns_to_process = list(metrics_plan_dict.keys())
    logger.info(f"–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤: {columns_to_process}")
    st.info(f"–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤, —É—á–∞—Å—Ç–≤—É—é—â–∏—Ö –≤ –∞–Ω–∞–ª–∏–∑–µ: {', '.join(columns_to_process)}")

    for col in columns_to_process:
        if col not in df_handled.columns:
            logger.warning(f"–°—Ç–æ–ª–±–µ—Ü '{col}' –∏–∑ –ø–ª–∞–Ω–∞ –º–µ—Ç—Ä–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DataFrame. –ü—Ä–æ–ø—É—â–µ–Ω.")
            st.warning(f"–°—Ç–æ–ª–±–µ—Ü '{col}' –∏–∑ –ø–ª–∞–Ω–∞ –º–µ—Ç—Ä–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–ø—É—â–µ–Ω.")
            continue

        dtype = df_handled[col].dtype
        logger.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–æ–ª–±—Ü–∞ '{col}' (—Ç–∏–ø: {dtype})")

        # 1. –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –≤ datetime —Å—Ç–æ–ª–±—Ü–∞—Ö
        if pd.api.types.is_datetime64_any_dtype(dtype):
            initial_rows = len(df_handled)
            df_handled = df_handled.dropna(subset=[col])
            final_rows = len(df_handled)
            logger.info(f"–°—Ç–æ–ª–±–µ—Ü '{col}' (datetime): —É–¥–∞–ª–µ–Ω–æ {initial_rows - final_rows} —Å—Ç—Ä–æ–∫ —Å NaT.")
            st.info(f"‚úÖ –°—Ç–æ–ª–±–µ—Ü '{col}' (datetime): —É–¥–∞–ª–µ–Ω–æ {initial_rows - final_rows} —Å—Ç—Ä–æ–∫ —Å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏.")
            continue # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å—Ç–æ–ª–±—Ü—É

        # 2. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤
        if df_handled[col].isna().any():
            if pd.api.types.is_numeric_dtype(dtype):
                # –ó–∞–ø–æ–ª–Ω—è–µ–º —á–∏—Å–ª–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã 0
                fill_value = 0
                df_handled[col] = df_handled[col].fillna(fill_value)
                logger.info(f"–°—Ç–æ–ª–±–µ—Ü '{col}' (—á–∏—Å–ª–æ–≤–æ–π): –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º {fill_value}.")
                st.info(f"‚úÖ –°—Ç–æ–ª–±–µ—Ü '{col}' (—á–∏—Å–ª–æ–≤–æ–π): –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º {fill_value}.")
            else:
                # –ó–∞–ø–æ–ª–Ω—è–µ–º –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
                fill_value = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
                df_handled[col] = df_handled[col].fillna(fill_value)
                logger.info(f"–°—Ç–æ–ª–±–µ—Ü '{col}' (–¥—Ä—É–≥–æ–π —Ç–∏–ø): –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º '{fill_value}'.")
                st.info(f"‚úÖ –°—Ç–æ–ª–±–µ—Ü '{col}' (–¥—Ä—É–≥–æ–π —Ç–∏–ø): –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º '{fill_value}'.")
        else:
            logger.debug(f"–°—Ç–æ–ª–±–µ—Ü '{col}' –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–ø—É—Å–∫–æ–≤.")

    logger.info("–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
    st.success("‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –¥–ª—è —É—á–∞—Å—Ç–≤—É—é—â–∏—Ö –≤ –∞–Ω–∞–ª–∏–∑–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
    return df_handled

# --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –§–£–ù–ö–¶–ò–ò ---

def safe_code_execution(code, context_name="", required_imports=None):
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Python –∫–æ–¥–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∏—Å–∫–ª—é—á–µ–Ω–∏–π, –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π df.
    –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º.
    """
    if required_imports is None:
        required_imports = []
    try:
        logger.info(f"–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è {context_name}...")
        # 1. –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å—Ç—ã–π Python-–∫–æ–¥
        clean_code = extract_python_code(code)
        logger.debug(f"–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –∫–æ–¥ ({context_name}):\n{textwrap.shorten(clean_code, width=200, placeholder='...')}")

        # 2. –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∏–º–ø–æ—Ä—Ç–∞–º–∏
        final_code_lines = []
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –≤ –Ω–∞—á–∞–ª–æ
        for imp in required_imports:
             final_code_lines.append(imp)
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –∫–æ–¥, —Ä–∞–∑–±–∏–≤ –µ–≥–æ –Ω–∞ —Å—Ç—Ä–æ–∫–∏
        final_code_lines.extend(clean_code.split('\n')) # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: split('\n')
        final_code_to_execute = "\n".join(final_code_lines) # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: "\n".join()
        logger.debug(f"–§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ({context_name}):\n{textwrap.shorten(final_code_to_execute, width=300, placeholder='...')}")

        # --- –î–û–ë–ê–í–õ–ï–ù–ò–ï: –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞ ---
        st.write(f"üîç –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è **{context_name}**...")
        warnings = static_code_analysis(final_code_to_execute, context_name)
        if warnings:
            st.warning(f"‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ –¥–ª—è **{context_name}**:")
            for w in warnings:
                st.markdown(f"* {w}")
            # –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º)
            st.info("‚ÑπÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è, –Ω–æ –∏–º–µ–π—Ç–µ –≤ –≤–∏–¥—É –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤—ã—à–µ...")
        else:
            st.success(f"‚úÖ –ö–æ–¥ –¥–ª—è **{context_name}** –ø—Ä–æ—à—ë–ª –ø—Ä–æ–≤–µ—Ä–∫—É.")
        # --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---

        # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ df –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º ---
        st.info(f"üîÑ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è **{context_name}**...")
        df = load_df_from_state()
        if df is not None:
            # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ)
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ datetime-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
            datetime_candidates = st.session_state.get("parsed_data_structure", {}).get("datetime_candidates", [])
            if datetime_candidates:
                df = preprocess_dates_based_on_llm(df, datetime_candidates)
            else:
                logger.info("–°–ø–∏—Å–æ–∫ datetime-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞—Ç.")

            # 2. –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–æ–¥–∞ –∞–Ω–∞–ª–∏–∑–∞/–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —ç—Ç–æ —ç—Ç–∞–ø—ã, –≥–¥–µ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ (—Ä–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ –∏–ª–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è)
            if context_name in ["—Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫", "–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏"]:
                 # –ü–æ–ª—É—á–∞–µ–º –ø–ª–∞–Ω –º–µ—Ç—Ä–∏–∫ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∂–µ —Å–æ–∑–¥–∞–Ω –∫ —ç—Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É)
                 metrics_plan_dict = st.session_state.get("metrics_plan_dict", {})
                 if metrics_plan_dict:
                     df = handle_missing_values_before_analysis(df, metrics_plan_dict)
                 else:
                     logger.warning("–ü–ª–∞–Ω –º–µ—Ç—Ä–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–∞.")
                     st.warning("‚ö†Ô∏è –ü–ª–∞–Ω –º–µ—Ç—Ä–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–∞.")

            # 3. –ü–µ—Ä–µ–¥–∞–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π df –≤ —Å—Ä–µ–¥—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            repl.locals["df"] = df
            logger.info(f"DF —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∏ –ø–µ—Ä–µ–¥–∞–Ω –≤ repl.locals –¥–ª—è {context_name}.")
            st.success(f"‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è **{context_name}**.")
        else:
            st.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è **{context_name}**. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ.")
            return f"–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è {context_name}."
        # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

        # 3. –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–¥
        output = repl.run(final_code_to_execute)
        logger.info(f"{context_name} –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ.")
        return output.strip()
    except Exception as e:
        error_msg = f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ {context_name}: {str(e)}"
        logger.error(error_msg)
        st.error(error_msg)
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑–≤–∞–ª –æ—à–∏–±–∫—É
        if 'final_code_to_execute' in locals():
            with st.expander("–ö–æ–¥, –≤—ã–∑–≤–∞–≤—à–∏–π –æ—à–∏–±–∫—É"):
                st.code(final_code_to_execute, language="python")
        else:
            with st.expander("–ö–æ–¥, –≤—ã–∑–≤–∞–≤—à–∏–π –æ—à–∏–±–∫—É"):
                st.code(code, language="python")
        return f"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {e}"
# --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø –∏ –î–û–ü–û–õ–ù–ï–ù–ò–Ø ---

def get_df_info(df, title="DataFrame"):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ DataFrame –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏."""
    if df is None:
        return f"{title} is None"
    if df.empty:
        return f"{title} is empty"
    buffer = StringIO()
    df.info(buf=buffer)
    info_str = buffer.getvalue()
    return (
        f"--- {title} ---\n"
        f"Shape: {df.shape}\n"
        f"Columns: {list(df.columns)}\n"
        f"Dtypes:\n{df.dtypes.to_string()}\n"
        f"Head:\n{df.head(2).to_string()}\n"
        f"Info:\n{info_str}\n"
        f"-------------------\n"
    )

# -----------------------------------------
# –í–≤–æ–¥: –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞
# -----------------------------------------
# -----------------------------------------
# –í–≤–æ–¥: –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
# -----------------------------------------
st.header("1. –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è
if "file_path" not in st.session_state:
    st.session_state["file_path"] = ""

df = None
file_path = st.text_input("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É (CSV –∏–ª–∏ Excel):", value=st.session_state["file_path"])

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
st.session_state["file_path"] = file_path

if not file_path:
    st.info("–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É.")
    st.stop()

if not os.path.exists(file_path):
    st.error("‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å.")
    st.stop()

try:
    if file_path.endswith(".csv"):
        try:
            df = pd.read_csv(file_path, encoding='utf-8')
        except UnicodeDecodeError:
            try:
                df = pd.read_csv(file_path, encoding='latin1')
            except:
                df = pd.read_csv(file_path, encoding='cp1251')
    elif file_path.endswith(".xlsx"):
        df = pd.read_excel(file_path)
    else:
        st.error("‚ùå –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ .csv –∏ .xlsx —Ñ–∞–π–ª—ã.")
        st.stop()
except Exception as e:
    st.error(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –ø–æ –ø—É—Ç–∏: {e}")
    st.exception(e)
    st.stop()

if df is None or df.empty:
    st.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç.")
    st.stop()

st.success("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!")
st.write("### üìã –ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–∏—Å—Ö–æ–¥–Ω—ã–µ):")
st.dataframe(df.head())
logger.info("DF –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:\n" + get_df_info(df, "df –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏"))

# -----------------------------------------
# –í–≤–æ–¥: –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
# -----------------------------------------
st.header("2. –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
output_dir = st.text_input("–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –æ—Ç—á—ë—Ç–∞:", value=".")
if not output_dir:
    st.warning("–£–∫–∞–∂–∏—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")
    st.stop()
try:
    os.makedirs(output_dir, exist_ok=True)
    st.success(f"‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≥–æ—Ç–æ–≤–∞: {output_dir}")
except Exception as e:
    st.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å/–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: {e}")
    st.stop()

test_file = os.path.join(output_dir, ".test_write")
try:
    with open(test_file, "w") as f:
        f.write("test")
    os.remove(test_file)
except Exception as e:
    st.error(f"‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: {e}")
    st.stop()

st.session_state["output_dir"] = output_dir

# -----------------------------------------
# –ì–æ—Ç–æ–≤–∏–º —Ü–µ–ø–æ—á–∫—É LangChain
# -----------------------------------------
st.header("3. –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞")
if st.button("üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑"):
    with st.spinner("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑..."):
        # –ó–∞–≥—Ä—É–∂–∞–µ–º df –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
        df_for_info = load_df_from_state()
        if df_for_info is None:
            st.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.")
            st.stop()

        # --- –®–∞–≥ 0: –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ df –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ LLM ---
        logger.info("DF –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∞–Ω–∞–ª–∏–∑–∞:\n" + get_df_info(df_for_info, "df –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∞–Ω–∞–ª–∏–∑–∞"))
        buffer = StringIO()
        df_for_info.info(buf=buffer)
        df_info = buffer.getvalue()
        file_info_summary = (
            f"DataFrame Info (—Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ):\n{df_info}\n"
            f"DataFrame Head:\n{df_for_info.head(10).to_string()}\n"
            f"DataFrame Dtypes:\n{df_for_info.dtypes.to_string()}\n"
            f"DataFrame Shape: {df_for_info.shape}\n"
        )
        logger.info("–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ —Å–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö.")

        # --- –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å –ø–æ–º–æ—â—å—é LLM ---
        with st.spinner("üß† –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö LLM..."):
            prompt_structure = PromptTemplate.from_template(struct_analyze)
            chain_structure = LLMChain(llm=llm_analyst, prompt=prompt_structure, output_key="data_structure")
            try:
                # --- –í–ê–ñ–ù–û: –ü–æ–ª—É—á–∞–µ–º "—Å—ã—Ä–æ–π" –æ—Ç–≤–µ—Ç ---
                result_structure_raw = chain_structure.run(file_info=file_info_summary)
                logger.info(f"–û—Ç–≤–µ—Ç LLM (–∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã):\n{result_structure_raw}")

                # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –ø–∞—Ä—Å–µ—Ä —Å—Ç—Ä–æ–∫ ---
                parsed_structure = parse_struct_analyze_response(result_structure_raw)
                # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
                
                if not parsed_structure:
                    st.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä–æ–∫–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –¥–∞–Ω–Ω—ã—Ö.")
                    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    with st.expander("–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç LLM (–°—Ç—Ä—É–∫—Ç—É—Ä–∞)"):
                         st.code(result_structure_raw, language="text")
                    st.stop() # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞

                # --- –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, —Ç–∞–∫ –∏ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å ---
                st.session_state["data_structure_raw"] = result_structure_raw # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                st.session_state["data_structure"] = json.dumps(parsed_structure, indent=2, ensure_ascii=False) # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                st.session_state["parsed_data_structure"] = parsed_structure # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                logger.info("–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ LLM.")
                st.success("‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ LLM.")

            except Exception as e:
                st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã LLM: {e}")
                # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–∫–∞—Ö
                if 'result_structure_raw' in locals():
                    with st.expander("–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç LLM (–°—Ç—Ä—É–∫—Ç—É—Ä–∞)"):
                        st.code(result_structure_raw, language="text")
                st.stop()

        # --- –®–∞–≥ 2: –ú–µ—Ç—Ä–∏–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π df –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã) ---
        with st.spinner("üìè –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞ –º–µ—Ç—Ä–∏–∫..."):
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ df –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ –º–µ—Ç—Ä–∏–∫
            # –ó–∞–≥—Ä—É–∂–∞–µ–º df –∑–∞–Ω–æ–≤–æ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞—Ç
            df_for_processing = load_df_from_state()
            if df_for_processing is None:
                st.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞ –º–µ—Ç—Ä–∏–∫.")
                st.stop()
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–∞—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ LLM
            datetime_candidates = st.session_state.get("parsed_data_structure", {}).get("datetime_candidates", [])
            df_processed = preprocess_dates_based_on_llm(df_for_processing, datetime_candidates)
            
            buffer_processed = StringIO()
            df_processed.info(buf=buffer_processed)
            df_info_processed = buffer_processed.getvalue()
            file_info_summary_processed = (
                f"DataFrame Info (–ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞—Ç):\n{df_info_processed}\n"
                f"DataFrame Head:\n{df_processed.head(10).to_string()}\n"
                f"DataFrame Dtypes:\n{df_processed.dtypes.to_string()}\n"
                f"DataFrame Shape: {df_processed.shape}\n"
            )

            # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–∂–µ—Å—Ç–æ—á–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç ---
            prompt_metrics = PromptTemplate.from_template(m_plan) 
            # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
            chain_metrics_plan = LLMChain(llm=llm_analyst, prompt=prompt_metrics, output_key="metrics_plan")
            try:
                # –ü–µ—Ä–µ–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
                result_metrics_plan_raw = chain_metrics_plan.run(data_structure=file_info_summary_processed)
                logger.info(f"–û—Ç–≤–µ—Ç LLM (–ø–ª–∞–Ω –º–µ—Ç—Ä–∏–∫):\n{result_metrics_plan_raw}") # --- –î–û–ë–ê–í–õ–ï–ù–ò–ï: –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç ---
                
                # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –ø–∞—Ä—Å–µ—Ä —Å—Ç—Ä–æ–∫ ---
                metrics_plan_dict = parse_metrics_plan_response(result_metrics_plan_raw)
                # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
                
                if not metrics_plan_dict: # --- –î–û–ë–ê–í–õ–ï–ù–ò–ï: –Ø–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ---
                    st.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä–æ–∫–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM –ø–æ –ø–ª–∞–Ω—É –º–µ—Ç—Ä–∏–∫.")
                    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    with st.expander("–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç LLM (–ü–ª–∞–Ω –º–µ—Ç—Ä–∏–∫)"):
                         st.code(result_metrics_plan_raw, language="text")
                    st.stop() # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                # --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---
                
                st.session_state["metrics_plan"] = json.dumps(metrics_plan_dict, indent=2, ensure_ascii=False)
                st.session_state["metrics_plan_dict"] = metrics_plan_dict
                logger.info("–ü–ª–∞–Ω –º–µ—Ç—Ä–∏–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
                st.success("‚úÖ –ü–ª–∞–Ω –º–µ—Ç—Ä–∏–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
            except Exception as e: # --- –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–∫–∞—Ö ---
                st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞ –º–µ—Ç—Ä–∏–∫: {e}")
                if 'result_metrics_plan_raw' in locals():
                    with st.expander("–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç LLM (–ü–ª–∞–Ω –º–µ—Ç—Ä–∏–∫)"):
                        st.code(result_metrics_plan_raw, language="text")
                st.session_state["metrics_plan"] = "{}"
                st.session_state["metrics_plan_dict"] = {}
                st.stop()
            # --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---

        # --- –®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ —Ä–∞—Å—á—ë—Ç–∞ ---
        with st.spinner("üíª –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –º–µ—Ç—Ä–∏–∫..."):
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ df –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞
            df_structure_info = f"DataFrame –∏–º–µ–µ—Ç {df_processed.shape[0]} —Å—Ç—Ä–æ–∫ –∏ {df_processed.shape[1]} —Å—Ç–æ–ª–±—Ü–æ–≤.\n"
            df_structure_info += "–¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ (–ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏):\n"
            for col in df_processed.columns:
                df_structure_info += f"  - {col}: {df_processed[col].dtype}\n"

            # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ü–†–û–ú–ü–¢–ê ---
            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—ã–≤–æ–¥ Python-—Å–ª–æ–≤–∞—Ä—è, –∞ –Ω–µ JSON
            prompt_code_gen = PromptTemplate.from_template(
                """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ Python –∏ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π Python-–∫–æ–¥ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∑–∞–¥–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º —Å—Ç–æ–ª–±—Ü–∞–º DataFrame —Å –≤—ã–≤–æ–¥–æ–º —á–µ—Ä–µ–∑ print(metrics_results).

–£ —Ç–µ–±—è –µ—Å—Ç—å DataFrame `df`, —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –≤ —Å—Ä–µ–¥—É. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ df:
{df_structure_info}

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–æ–ª–±—Ü–æ–≤:
{metrics_plan}

–°–ª–µ–¥—É–π —ç—Ç–∏–º –ø—Ä–∞–≤–∏–ª–∞–º:

- –≤—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ—Å–º —É—Ä–æ–≤–Ω–µ
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ pandas, numpy. –ù–µ –¥–æ–±–∞–≤–ª—è–π —Å—Ç—Ä–æ–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ ‚Äî –æ–Ω–∏ —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã.
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–π –¢–û–õ–¨–ö–û —Ç–µ –º–µ—Ç—Ä–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑–∞–Ω—ã –≤ `{metrics_plan}` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞.
- –ü–†–ï–ñ–î–ï —á–µ–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ `df["–∏–º—è_—Å—Ç–æ–ª–±—Ü–∞"]`, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä—è–π, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ç–æ–ª–±–µ—Ü –≤ `df.columns`. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏.
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞:
  - –°–æ–∑–¥–∞–π –∫–æ–ø–∏—é: `series = df[col].copy()`
  - –í—Å–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (NaN, NaT) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∫–∞–∫ `None` –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ. –ù–µ –æ—Å—Ç–∞–≤–ª—è–π `nan`, `nat` –∏–ª–∏ `np.nan`.
  #
- –î–ª—è –º–µ—Ç—Ä–∏–∫, —Ç—Ä–µ–±—É—é—â–∏—Ö resample (–Ω–∞–ø—Ä–∏–º–µ—Ä, dates_per_month, dates_per_year):
1. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π series.resample(...) –Ω–∞–ø—Ä—è–º—É—é, –µ—Å–ª–∏ series.index –Ω–µ —è–≤–ª—è–µ—Ç—Å—è DatetimeIndex.
2. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–π –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å–µ—Ä–∏—é, –≥–¥–µ –∏–Ω–¥–µ–∫—Å - —ç—Ç–æ —Å–∞–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è datetime
#

- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤:
  - –í—Å–µ —Å–∫–∞–ª—è—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–µ—Ç—Ä–∏–∫) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ç–∏–ø–∞—Ö Python: `int`, `float`, `str`, `bool`, `None`.
  - –ò—Å–ø–æ–ª—å–∑—É–π: `int(x)` –¥–ª—è —Ü–µ–ª—ã—Ö, `float(x)` –¥–ª—è –≤–µ—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö, `str(x)` –¥–ª—è –¥–∞—Ç, `.tolist()` –¥–ª—è —Å–ø–∏—Å–∫–æ–≤.
  - –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî `NaN`, `NaT` –∏–ª–∏ `None`, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `None`.
  - –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ (mean, std –∏ —Ç.–¥.) –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–∫–∏ —Å —Ç–∏–ø–æ–º `int64`, `float64`, –∏–ª–∏ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —á–∏—Å–ª–æ–≤–æ–π —Ç–∏–ø —á–µ—Ä–µ–∑ `pd.to_numeric(series, errors='coerce')`. –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî NaN, —Å—á–∏—Ç–∞–π –∫–æ–ª–æ–Ω–∫—É –Ω–µ—á–∏—Å–ª–æ–≤–æ–π.

- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤:
  - –ù–µ –∏–∑–º–µ–Ω—è–π –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
  - –í–º–µ—Å—Ç–æ `series.fillna(None)` –∏—Å–ø–æ–ª—å–∑—É–π: `series = series.where(pd.notna(series), None)` ‚Äî —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤.
  - –ò–ª–∏, –µ—Å–ª–∏ –º–µ—Ç—Ä–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, mean), –∏—Å–ø–æ–ª—å–∑—É–π `series.dropna()` **—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —ç—Ç–æ–π –º–µ—Ç—Ä–∏–∫–∏**, –Ω–µ –∏–∑–º–µ–Ω—è—è `series` –≥–ª–æ–±–∞–ª—å–Ω–æ.

- –î–ª—è datetime-–º–µ—Ç—Ä–∏–∫:
  - –£–±–µ–¥–∏—Å—å, —á—Ç–æ `series.dtype == 'datetime64[ns]'`.
  - –î–ª—è `dates_per_month`: —Å–æ–∑–¥–∞–π –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å–µ—Ä–∏—é: `temp = pd.Series(1, index=pd.to_datetime(series.dropna()))`, –∑–∞—Ç–µ–º `temp.resample('M').count().tolist()`.

- –ü—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ –∫–æ–¥–∞ —Å NumPy-–º–∞—Å—Å–∏–≤–∞–º–∏ –∏—Å–ø–æ–ª—å–∑—É–π —è–≤–Ω—ã–µ —É—Å–ª–æ–≤–∏—è: np.any(condition) –∏–ª–∏ np.all(condition) –≤–º–µ—Å—Ç–æ if condition:
- –î–ª—è `mad`: –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª—É: `mad_val = (series - series.mean()).abs().mean()`, –µ—Å–ª–∏ `series` —á–∏—Å–ª–æ–≤–∞—è.
- –ù–µ –∏–∑–º–µ–Ω—è–π `df`, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–π –∏–Ω–¥–µ–∫—Å, –Ω–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π —Ç–∏–ø –∏–Ω–¥–µ–∫—Å–∞.
- –ò–∑–±–µ–≥–∞–π –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ —Å—á–∏—Ç–∞–π `quantile(0.25)` –¥–≤–∞–∂–¥—ã).
- –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–≤–æ–±–æ–¥–µ–Ω –æ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –∏ –≥–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é.
- –í—ã–≤–µ–¥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π: print(metrics_results)

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ Python-–∫–æ–¥ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π (–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ), –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""
#                 """
#             –¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ Python –∏ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π Python-–∫–æ–¥ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∑–∞–¥–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º —Å—Ç–æ–ª–±—Ü–∞–º DataFrame —Å –≤—ã–≤–æ–¥–æ–º –ø—Ä–∏ –ø–æ–º–æ—â–∏ print(metrics_results)

# –£ —Ç–µ–±—è –µ—Å—Ç—å DataFrame `df`, —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –≤ —Å—Ä–µ–¥—É. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ df:
# {df_structure_info}

# –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–æ–ª–±—Ü–æ–≤:
# {metrics_plan}

# –°–ª–µ–¥—É–π —ç—Ç–∏–º –ø—Ä–∞–≤–∏–ª–∞–º:
# - –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ pandas, numpy –∏ scipy (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ). –ù–µ –¥–æ–±–∞–≤–ª—è–π —Å—Ç—Ä–æ–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ ‚Äî –æ–Ω–∏ —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã.
# - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–π –¢–û–õ–¨–ö–û —Ç–µ –º–µ—Ç—Ä–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑–∞–Ω—ã –≤ `{metrics_plan}` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞. 
# - –ü–†–ï–ñ–î–ï –ß–ï–ú –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ `df["–∏–º—è_—Å—Ç–æ–ª–±—Ü–∞"]`, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä—è–π, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–∫–æ–π —Å—Ç–æ–ª–±–µ—Ü –≤ `df.columns`
# - –ü–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º –º–µ—Ç—Ä–∏–∫ –¥–ª—è —á–∏—Å–ª–æ–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ —É–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–Ω –∏–º–µ–µ—Ç —á–∏—Å–ª–æ–≤–æ–π —Ç–∏–ø (int, float). 
# - –ü—Ä–µ–æ–±—Ä–∞–∑—É–π –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç–∏–ø–æ–≤ NumPy (–Ω–∞–ø—Ä–∏–º–µ—Ä, numpy.int64, numpy.float64) –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–∏–ø—ã Python: –∏—Å–ø–æ–ª—å–∑—É–π `int()`, `float()`, `bool()` –¥–ª—è —Å–∫–∞–ª—è—Ä–æ–≤, `.tolist()` –¥–ª—è –º–∞—Å—Å–∏–≤–æ–≤, `str()` –¥–ª—è –¥–∞—Ç.
# - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (NaN, NaT) ‚Äî –∑–∞–º–µ–Ω—è–π –∏—Ö –Ω–∞ `None`.
# - –í—ã–≤–µ–¥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¢–û–õ–¨–ö–û –û–î–ù–û–ô —Å—Ç—Ä–æ–∫–æ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ Python-—Å–ª–æ–≤–∞—Ä—è: print(metrics_results)

# - –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–µ –¥—É–±–ª–∏—Ä—É–π –∫–æ–¥, –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.
# - –ù–µ –∏–∑–º–µ–Ω—è–π –∏—Å—Ö–æ–¥–Ω—ã–π DataFrame (`df`), –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–π –∏–Ω–¥–µ–∫—Å, –Ω–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–Ω–¥–µ–∫—Å–∞.
# - –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–æ–¥ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –∏ –≥–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é.
# - –î–ª—è –º–µ—Ç—Ä–∏–∫, —Ç—Ä–µ–±—É—é—â–∏—Ö resample (–Ω–∞–ø—Ä–∏–º–µ—Ä, dates_per_month, dates_per_year):
# 1. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π series.resample(...) –Ω–∞–ø—Ä—è–º—É—é, –µ—Å–ª–∏ series.index –Ω–µ —è–≤–ª—è–µ—Ç—Å—è DatetimeIndex.
# 2. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–π –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å–µ—Ä–∏—é, –≥–¥–µ –∏–Ω–¥–µ–∫—Å - —ç—Ç–æ —Å–∞–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è datetime

# -–î–ª—è —Ä–∞—Å—á–µ—Ç–∞ `mad` (Mean Absolute Deviation) –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π `series.mad()` –Ω–∞–ø—Ä—è–º—É—é, –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –µ–≥–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–∏. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω—É—é —Ñ–æ—Ä–º—É–ª—É: `mad_val = series.sub(series.mean()).abs().mean()`.

# –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ Python-–∫–æ–¥ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –≤—ã–≤–æ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.
# """
            )

            # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ü–†–û–ú–ü–¢–ê ---
            chain_code_gen = LLMChain(llm=llm_coder, prompt=prompt_code_gen, output_key="calculation_code")
            metrics_plan_for_prompt = st.session_state.get("metrics_plan", "{}")
            if "metrics_plan_dict" in st.session_state and st.session_state["metrics_plan_dict"]:
                 metrics_plan_for_prompt = json.dumps(st.session_state["metrics_plan_dict"], indent=2, ensure_ascii=False)
            try:
                result_code_gen = chain_code_gen.run(metrics_plan=metrics_plan_for_prompt, df_structure_info=df_structure_info)
                st.session_state["calculation_code"] = result_code_gen
                logger.info("–ö–æ–¥ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –º–µ—Ç—Ä–∏–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
                st.success("‚úÖ –ö–æ–¥ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –º–µ—Ç—Ä–∏–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
            except Exception as e:
                st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞ —Ä–∞—Å—á—ë—Ç–∞ –º–µ—Ç—Ä–∏–∫: {e}")
                st.session_state["calculation_code"] = "# –ö–æ–¥ –Ω–µ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏."
                st.stop()

        # --- –®–∞–≥ 4: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫ ---
        # --- –®–∞–≥ 4: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫ ---
        with st.spinner("üìä –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫..."):
            required_imports_for_metrics = [
                "import pandas as pd",
                "import numpy as np",
                # json –∏ ast –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è, –µ—Å–ª–∏ –º—ã –Ω–µ –ø–∞—Ä—Å–∏–º
            ]
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–¥ –∏ –ø–æ–ª—É—á–∞–µ–º –≤—ã–≤–æ–¥ –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
            metrics_results_raw_output = safe_code_execution(
                st.session_state["calculation_code"],
                "—Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫",
                required_imports=required_imports_for_metrics
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º "—Å—ã—Ä–æ–π" –≤—ã–≤–æ–¥ –∫–∞–∫ —Å—Ç—Ä–æ–∫—É, –±–µ–∑ –ø–æ–ø—ã—Ç–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞
            st.session_state["metrics_results_raw"] = metrics_results_raw_output
            
            # –ü–æ—Å–∫–æ–ª—å–∫—É –ø–∞—Ä—Å–∏–Ω–≥ —É–±—Ä–∞–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º metrics_results –∫–∞–∫ –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å
            # –∏–ª–∏ –∫–∞–∫ —Å–∞–º—É —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –≤–∞—à–∞ –ª–æ–≥–∏–∫–∞ –≥–¥–µ-—Ç–æ –µ—â–µ –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ –Ω–µ–≥–æ.
            # –ï—Å–ª–∏ –Ω–∏–≥–¥–µ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Å–ª–æ–≤–∞—Ä—å, –º–æ–∂–Ω–æ –∏ –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å.
            # st.session_state["metrics_results"] = {} # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –æ–∂–∏–¥–∞–µ—Ç—Å—è

            logger.info("–ú–µ—Ç—Ä–∏–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã (–≤—ã–≤–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞).")
            st.success("‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã! –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞.")

            # --- –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫ –≤ .py ---
            try:
                # –ü–æ–ª—É—á–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                output_dir_for_code = st.session_state.get("output_dir", ".")
                calculation_code_filename = "generated_calculation_code.py"
                calculation_code_path = os.path.join(output_dir_for_code, calculation_code_filename)

                # –ü–æ–ª—É—á–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–¥–∞
                calculation_code_content = st.session_state.get("calculation_code", "# –ö–æ–¥ –Ω–µ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")

                # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                if not isinstance(calculation_code_content, str):
                    calculation_code_content = str(calculation_code_content)

                # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–¥ –≤ —Ñ–∞–π–ª .py
                with open(calculation_code_path, "w", encoding="utf-8") as f_py:
                    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
                    f_py.write("# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫\n")
                    f_py.write("# -------------------------------------\n\n")
                    f_py.write(calculation_code_content)

                logger.info(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ PY: {calculation_code_path}")
                # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –≤—ã–≤–µ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                st.success(f"‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ PY: {calculation_code_path}")
            except Exception as e_code_save:
                error_msg_code_save = f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫ –≤ PY: {e_code_save}"
                logger.error(error_msg_code_save)
                st.error(error_msg_code_save)
            # --- –ë–õ–û–ö –ü–ê–†–°–ò–ù–ì–ê –£–î–ê–õ–ï–ù ---
            # (–í–µ—Å—å —Å—Ç–∞—Ä—ã–π try...except —Å json.loads –∏–ª–∏ ast.literal_eval –∑–¥–µ—Å—å –±—ã–ª)
            
            # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –≤ –≤—ã–≤–æ–¥–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ) ---
            if isinstance(metrics_results_raw_output, str) and ("–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è" in metrics_results_raw_output or "Traceback" in metrics_results_raw_output):
                 st.error("‚ùå –ü–æ—Ö–æ–∂–µ, –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞ —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")
                 st.code(metrics_results_raw_output, language="text")
                 st.stop() # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, –µ—Å–ª–∏ –∫–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ
            # --- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ ---

        # --- –®–∞–≥ 5: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ ---
        with st.spinner("üîç –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫..."):
            prompt_analysis = PromptTemplate.from_template(data_analyze)
            # –ü–µ—Ä–µ–¥–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π "—Å—ã—Ä–æ–π" –≤—ã–≤–æ–¥ –≤ –ø—Ä–æ–º–ø—Ç –∞–Ω–∞–ª–∏–∑–∞
            prompt_analysis = prompt_analysis.partial(metrics_results_raw=st.session_state["metrics_results_raw"])
            chain_analysis = LLMChain(llm=llm_analyst, prompt=prompt_analysis, output_key="analysis_summary")
            try:
                result_analysis = chain_analysis.invoke({})
                raw_analysis_summary = result_analysis.get("analysis_summary", "–ê–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω.")
                st.session_state["analysis_summary"] = convert_numpy_types(raw_analysis_summary)
                logger.info("–ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ –∑–∞–≤–µ—Ä—à—ë–Ω.")
                st.success("‚úÖ –ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ –∑–∞–≤–µ—Ä—à—ë–Ω.")

                # --- –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ–± –∞–Ω–∞–ª–∏–∑–µ –º–µ—Ç—Ä–∏–∫ ---
                # –ü–æ–ª—É—á–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                output_dir_for_analysis = st.session_state.get("output_dir", ".")
                analysis_report_filename_base = "analysis_summary_report"
                analysis_report_txt_path = os.path.join(output_dir_for_analysis, f"{analysis_report_filename_base}.txt")
                analysis_report_docx_path = os.path.join(output_dir_for_analysis, f"{analysis_report_filename_base}.docx")

                # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                analysis_content_to_save = st.session_state["analysis_summary"]
                if not isinstance(analysis_content_to_save, str):
                    analysis_content_to_save = str(convert_numpy_types(analysis_content_to_save))

                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ .txt
                try:
                    with open(analysis_report_txt_path, "w", encoding="utf-8") as f_txt:
                        f_txt.write(analysis_content_to_save)
                    logger.info(f"–û—Ç—á–µ—Ç –æ–± –∞–Ω–∞–ª–∏–∑–µ –º–µ—Ç—Ä–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ TXT: {analysis_report_txt_path}")
                    st.success(f"‚úÖ –û—Ç—á–µ—Ç –æ–± –∞–Ω–∞–ª–∏–∑–µ –º–µ—Ç—Ä–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ TXT: {analysis_report_txt_path}")
                except Exception as e_txt:
                    error_msg_txt = f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞ –æ–± –∞–Ω–∞–ª–∏–∑–µ –º–µ—Ç—Ä–∏–∫ –≤ TXT: {e_txt}"
                    logger.error(error_msg_txt)
                    st.error(error_msg_txt)

                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ .docx
                try:
                    from docx import Document # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ try, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –≤—Å—ë –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
                    doc = Document()
                    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    doc.add_heading('–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫', level=1)
                    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á–µ—Ç–∞ –∫–∞–∫ –ø–∞—Ä–∞–≥—Ä–∞—Ñ(—ã)
                    # splitlines –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                    for line in analysis_content_to_save.splitlines():
                        if line.strip(): # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
                            doc.add_paragraph(line)
                        # –ï—Å–ª–∏ –≤–µ—Å—å —Ç–µ–∫—Å—Ç –Ω—É–∂–Ω–æ –≤ –æ–¥–∏–Ω –ø–∞—Ä–∞–≥—Ä–∞—Ñ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
                        # doc.add_paragraph(analysis_content_to_save)
                    doc.save(analysis_report_docx_path)
                    logger.info(f"–û—Ç—á–µ—Ç –æ–± –∞–Ω–∞–ª–∏–∑–µ –º–µ—Ç—Ä–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ DOCX: {analysis_report_docx_path}")
                    st.success(f"‚úÖ –û—Ç—á–µ—Ç –æ–± –∞–Ω–∞–ª–∏–∑–µ –º–µ—Ç—Ä–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ DOCX: {analysis_report_docx_path}")
                except ImportError as e_import:
                    error_msg_import = f"‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ python-docx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –û—Ç—á–µ—Ç –≤ DOCX –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {e_import}"
                    logger.error(error_msg_import)
                    st.error(error_msg_import)
                except Exception as e_docx:
                    error_msg_docx = f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞ –æ–± –∞–Ω–∞–ª–∏–∑–µ –º–µ—Ç—Ä–∏–∫ –≤ DOCX: {e_docx}"
                    logger.error(error_msg_docx)
                    st.error(error_msg_docx)
                # --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û ---

            except Exception as e:
                st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –º–µ—Ç—Ä–∏–∫: {e}")
                st.session_state["analysis_summary"] = "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞."

        # --- –®–∞–≥ 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ ---
        with st.spinner("üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏..."):
            
            prompt_viz = PromptTemplate.from_template(
               """# üéØ –¶–ï–õ–¨
–ü–æ—Å—Ç—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫–∏, –∏–ª–ª—é—Å—Ç—Ä–∏—Ä—É—é—â–∏–µ –û–°–ù–û–í–ù–´–ï –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ –º–µ—Ç—Ä–∏–∫. –ö–∞–∂–¥—ã–π –≥—Ä–∞—Ñ–∏–∫ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –£–ù–ò–ö–ê–õ–¨–ù–£–ô –∏–Ω—Å–∞–π—Ç. –ù–ï –î–£–ë–õ–ò–†–£–ô –ò–î–ï–ò.

# ‚ö†Ô∏è –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø
- –ü–æ—Å—Ç—Ä–æ–π —Ä–æ–≤–Ω–æ 30 –≥—Ä–∞—Ñ–∏–∫–æ–≤, –Ω–µ –±–æ–ª—å—à–µ, –Ω–µ –º–µ–Ω—å—à–µ

# üìä –¢–ò–ü–´ –ì–†–ê–§–ò–ö–û–í (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (hist, kde, box, violin)
- –°–≤—è–∑—å —á–∏—Å–ª–æ–≤–æ–π –∏ categor–∏–∞–ª—å–Ω–æ–π (boxplot/violinplot)
- –°–≤—è–∑—å –¥–≤—É—Ö —á–∏—Å–ª–æ–≤—ã—Ö (scatter —Å hue, regplot)
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ (barplot, countplot)
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã (–∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º)
- –í–∑–∞–∏–º–æ—Å–≤—è–∑–∏ (heatmap –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π, crosstab)
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã (–∞–Ω–æ–º–∞–ª–∏–∏, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø)

# üé® –¶–í–ï–¢–û–í–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø
- –í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ü–≤–µ—Ç–Ω—ã–º–∏.
- –í barplot –∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞—Ö –ö–ê–ñ–î–´–ô —Å—Ç–æ–ª–±–µ—Ü –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Å–≤–æ–π —Ü–≤–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É–π palette, hue, –∏–ª–∏ color –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞)
- –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞–ª–∏—Ç—Ä—ã: `palette='tab10'`, `cmap='viridis'`, `color=...`, `hue=...`.
- –ü—Ä–∏–º–µ–Ω—è–π `hue`, `palette`, `cmap` –≤–µ–∑–¥–µ, –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ.
- –ù–µ –æ—Å—Ç–∞–≤–ª—è–π –≥—Ä–∞—Ñ–∏–∫–∏ —á–µ—Ä–Ω–æ-–±–µ–ª—ã–º–∏ –∏–ª–∏ –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–º–∏.
- –í barplot –∏—Å–ø–æ–ª—å–∑—É–π `palette` –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–≤–∞–π —Å–ø–∏—Å–æ–∫ —Ü–≤–µ—Ç–æ–≤, —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π —Å—Ç–æ–ª–±–µ—Ü –±—ã–ª —Ä–∞–∑–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞.

# üö´ –ó–ê–ü–†–ï–©–ï–ù–û
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–¥–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –±–µ–∑ –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)
- –ì—Ä–∞—Ñ–∏–∫–∏ –±–µ–∑ –∏–Ω—Å–∞–π—Ç–æ–≤
- –ü—Ä–æ–ø—É—Å–∫ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏–∑-–∑–∞ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π top-N
- –ë–æ–ª–µ–µ 30 –≥—Ä–∞—Ñ–∏–∫–æ–≤
- –û–¥–Ω–æ—Ç–æ–Ω–Ω—ã–µ barplot (–≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞)

# üì• –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
–£ —Ç–µ–±—è –µ—Å—Ç—å:
- DataFrame `df`
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {df_structure_info}
- –ú–µ—Ç—Ä–∏–∫–∏: {metrics_results_raw}
- –ê–Ω–∞–ª–∏–∑: {analysis_summary}

# ‚úÖ –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø
- –ò—Å–ø–æ–ª—å–∑—É–π `matplotlib`, `seaborn`
- –°–æ—Ö—Ä–∞–Ω—è–π –≤ `{output_dir}` –∫–∞–∫ `plot_{{—Å—Ç–æ–ª–±—Ü—ã}}_{{—Ç–∏–ø}}.png`
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π `plt.show()`, —Ç–æ–ª—å–∫–æ `plt.savefig()`
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π `try-except`
- –ò—Å–ø–æ–ª—å–∑—É–π `palette='tab10'`, `cmap='viridis'`
- –î–ª—è –æ—Å–∏ X —Å >5 –º–µ—Ç–æ–∫: `rotation=45`, `ha='right'`
- –í—Å–µ–≥–¥–∞ `plt.tight_layout()`
- –°–æ–∑–¥–∞–π –ø–∞–ø–∫—É: `os.makedirs('{output_dir}', exist_ok=True)`
- –ù–µ –∏–∑–º–µ–Ω—è–π `df`, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–π –∑–∞–Ω–æ–≤–æ
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –∫–æ–¥ (30 –≥—Ä–∞—Ñ–∏–∫–æ–≤!!! —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –≤—Ä–æ–¥–µ #–ì—Ä–∞—Ñ–∏–∫ 1: ... ). 
"""
           )
           
            # df_structure_info —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤—ã—à–µ
            # prompt_viz = PromptTemplate.from_template(
            #     """
            #     –¢—ã –ø–æ–ª—É—á–∏–ª DataFrame `df`, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Å—Ä–µ–¥—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Python. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ df:
            #     {df_structure_info}
            #     –¢–∞–∫–∂–µ —Ç—ã –ø–æ–ª—É—á–∏–ª —Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑:
            #     --- –ú–µ—Ç—Ä–∏–∫–∏ ---
            #     {metrics_results_raw}
            #     --- –ê–Ω–∞–ª–∏–∑ ---
            #     {analysis_summary}
            #     –¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Python-–∫–æ–¥ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ `df` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º matplotlib –∏ seaborn.
            #     –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
            #     - –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤: –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã, boxplot, KDE.
            #     - –î–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö: bar plot —Å —á–∞—Å—Ç–æ—Ç–∞–º–∏.
            #     - –î–ª—è –¥–∞—Ç (datetime): –ª–∏–Ω–µ–π–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤, –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º (–º–µ—Å—è—Ü–∞–º, –≥–æ–¥–∞–º).
            #     - –ï—Å–ª–∏ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ —á–∏—Å–ª–æ–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞: heatmap –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π.
            #     - –í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–π –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É '{output_dir}'.
            #     - –ò–º—è —Ñ–∞–π–ª–∞: plot_{{—Å—Ç–æ–ª–±–µ—Ü}}_{{—Ç–∏–ø}}.png
            #     - –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–π –≥—Ä–∞—Ñ–∏–∫–∏ (plt.show()), —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–π (plt.savefig).
            #     - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è).
            #     - –£—á–∏—Ç—ã–≤–∞–π, —á—Ç–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–ª–±—Ü—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Ç–∏–ø–∞ `datetime64[ns]`.
            #     - –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ df –≤—ã—à–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤.
            #     - –ù–ï –ø—ã—Ç–∞–π—Å—è –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–Ω–æ–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –ø–æ–º–æ—â—å—é pd.read_csv). –ò—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `df`, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
            #     - –ù–ï –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–π –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `df`.
            #     - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π `del df`.
            #     - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π `df.resample(...)` –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ df –∏–ª–∏ —Å—Ç–æ–ª–±—Ü–µ, –µ—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è DatetimeIndex. –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏ datetime-—Å—Ç–æ–ª–±–µ—Ü –∫–∞–∫ –∏–Ω–¥–µ–∫—Å: `df.set_index('date_column')`.
            #     - –ù–ï –ø–∏—à–∏ ```python
            #     –í–∫–ª—é—á–∏ –≤ –∫–æ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç.
            #     –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –∫–æ–¥. –ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–æ–¥ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.
            #     """
            # )
            
#            prompt_viz = PromptTemplate.from_template(
# """
# # ‚ö†Ô∏è –í–ê–ñ–ù–û: –°–¢–†–û–ì–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï
# –ü–æ—Å—Ç—Ä–æ–π –†–û–í–ù–û 20 –ì–†–ê–§–ò–ö–û–í. –ù–∏ –±–æ–ª—å—à–µ, –Ω–∏ –º–µ–Ω—å—à–µ. –ï—Å–ª–∏ —Ç—ã –ø–æ—Å—Ç—Ä–æ–∏–ª 20 ‚Äî –∫–æ–¥ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è. –ù–µ –¥–æ–±–∞–≤–ª—è–π –±–æ–ª—å—à–µ.

# # üéØ –¶–ï–õ–¨
# –ö–∞–∂–¥—ã–π –≥—Ä–∞—Ñ–∏–∫ –¥–æ–ª–∂–µ–Ω –∏–ª–ª—é—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –£–ù–ò–ö–ê–õ–¨–ù–£–Æ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å –∏–∑ –∞–Ω–∞–ª–∏–∑–∞. –ù–ï –î–£–ë–õ–ò–†–£–ô –ò–î–ï–ò.

# # üìä –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
# - 2: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (—Ä–∞–∑–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã, —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã: hist, kde, box, violin)
# - 3: —Å–≤—è–∑—å —á–∏—Å–ª–æ–≤–æ–π –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω–æ–π (boxplot/violinplot –¥–ª—è –ø–∞—Ä —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º–∏ —Ä–∞–∑–ª–∏—á–∏—è–º–∏)
# - 4: —Å–≤—è–∑—å –¥–≤—É—Ö —á–∏—Å–ª–æ–≤—ã—Ö (scatter —Å hue, regplot)
# - 5: –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ (barplot, top-15)
# - 2: –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã (–∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º)
# - 2: –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ (heatmap –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π, heatmap crosstab)
# - 2: —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∞–Ω–æ–º–∞–ª–∏–∏, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≥—Ä—É–ø–ø)

# # üé® –¶–í–ï–¢–û–í–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø
# - –í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ü–≤–µ—Ç–Ω—ã–º–∏.
# - –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞–ª–∏—Ç—Ä—ã: `palette='tab10'`, `cmap='viridis'`, `color=...`, `hue=...`.
# - –î–ª—è scatterplot, barplot, boxplot –∏ —Ç.–¥. –ø—Ä–∏–º–µ–Ω—è–π `hue`, `palette`, `cmap` –≤–µ–∑–¥–µ, –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ.
# - –ù–µ –æ—Å—Ç–∞–≤–ª—è–π –≥—Ä–∞—Ñ–∏–∫–∏ —á–µ—Ä–Ω–æ-–±–µ–ª—ã–º–∏ –∏–ª–∏ –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–º–∏.

# # üö´ –ó–ê–ü–†–ï–©–ï–ù–û
# - >20 –≥—Ä–∞—Ñ–∏–∫–æ–≤
# - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, hist + kde + box –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞)
# - –ì—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ –±–µ–∑ –∏–Ω—Å–∞–π—Ç–æ–≤
# - –ü—Ä–æ–ø—É—Å–∫ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏–∑-–∑–∞ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π top-N

# # üì• –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
# –£ —Ç–µ–±—è –µ—Å—Ç—å:
# - DataFrame `df`
# - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {df_structure_info}
# - –ú–µ—Ç—Ä–∏–∫–∏: {metrics_results_raw}
# - –ê–Ω–∞–ª–∏–∑: {analysis_summary}

# # ‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–æ–¥—É
# - –ò—Å–ø–æ–ª—å–∑—É–π `matplotlib`, `seaborn`
# - –°–æ—Ö—Ä–∞–Ω—è–π –≤ `{output_dir}` –∫–∞–∫ `plot_{{—Å—Ç–æ–ª–±—Ü—ã}}_{{—Ç–∏–ø}}.png`
# - –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π `plt.show()`, —Ç–æ–ª—å–∫–æ `plt.savefig()`
# - –ö–∞–∂–¥—ã–π –≥—Ä–∞—Ñ–∏–∫ –≤ `try-except`
# - –ò—Å–ø–æ–ª—å–∑—É–π `palette='tab10'`, `cmap='viridis'`
# - –î–ª—è –æ—Å–∏ X —Å >5 –º–µ—Ç–æ–∫: `rotation=45`, `ha='right'`
# - –í—Å–µ–≥–¥–∞ `plt.tight_layout()`
# - –°–æ–∑–¥–∞–π –ø–∞–ø–∫—É: `os.makedirs('{output_dir}', exist_ok=True)`
# - –ù–µ –∏–∑–º–µ–Ω—è–π `df`, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–π –∑–∞–Ω–æ–≤–æ
# - –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –∫–æ–¥. –ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π. –ë–µ–∑ ```python
# """)

      
        prompt_viz = prompt_viz.partial(
            df_structure_info=df_structure_info,
            metrics_results_raw=st.session_state["metrics_results_raw"],
            analysis_summary=st.session_state["analysis_summary"],
            output_dir=output_dir
        )
        chain_viz_code = LLMChain(llm=llm_coder, prompt=prompt_viz, output_key="viz_code")
        try:
            result_viz_code = chain_viz_code.invoke({})
            raw_viz_code = result_viz_code.get("viz_code", "# –ö–æ–¥ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
            if not isinstance(raw_viz_code, str):
                st.session_state["viz_code"] = str(convert_numpy_types(raw_viz_code))
            else:
                st.session_state["viz_code"] = raw_viz_code
            logger.info("–ö–æ–¥ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
            st.success("‚úÖ –ö–æ–¥ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
            st.session_state["viz_code"] = f"# –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}\n# –ö–æ–¥ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏."

        # --- –®–∞–≥ 7: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ ---
        with st.spinner("üñºÔ∏è –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤..."):
            required_imports_for_viz = [
                "import pandas as pd",
                "import numpy as np",
                "import matplotlib",
                "matplotlib.use('Agg')",
                "import matplotlib.pyplot as plt",
                "import seaborn as sns",
                "import json",
                "import os"
            ]
            viz_output = safe_code_execution(
                st.session_state["viz_code"],
                "–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏",
                required_imports=required_imports_for_viz
            )
            if "error" not in viz_output.lower() and "–æ—Ç–º–µ–Ω–µ–Ω–æ" not in viz_output.lower():
                st.success("‚úÖ –ì—Ä–∞—Ñ–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.")
            logger.info("–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
        try:
                        # –ü–æ–ª—É—á–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            output_dir_for_viz_code = st.session_state.get("output_dir", ".")
            viz_code_filename = "generated_visualization_code.py"
            viz_code_path = os.path.join(output_dir_for_viz_code, viz_code_filename)

            # –ü–æ–ª—É—á–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–¥–∞
            viz_code_content = st.session_state.get("viz_code", "# –ö–æ–¥ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")

            # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
            if not isinstance(viz_code_content, str):
                viz_code_content = str(viz_code_content)

            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–¥ –≤ —Ñ–∞–π–ª .py
            with open(viz_code_path, "w", encoding="utf-8") as f_py:
                # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
                f_py.write("# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏\n")
                f_py.write("# ----------------------------------\n\n")
                f_py.write(viz_code_content)

            logger.info(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ PY: {viz_code_path}")
            # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –≤—ã–≤–µ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            st.success(f"‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ PY: {viz_code_path}")
        except Exception as e_viz_code_save:
            error_msg_viz_code_save = f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ PY: {e_viz_code_save}"
            logger.error(error_msg_viz_code_save)
            st.error(error_msg_viz_code_save)

        # --- –®–∞–≥ 8: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞ ---
        with st.spinner("üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞..."):
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
            if "analysis_summary" not in st.session_state or not st.session_state["analysis_summary"]:
                error_msg = "‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç: –∞–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ –Ω–µ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."
                st.error(error_msg)
                st.session_state["final_report"] = error_msg # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                logger.error("–ü–æ–ø—ã—Ç–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞ (analysis_summary –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ st.session_state).")
                st.stop() # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

            prompt_report = PromptTemplate.from_template(final_rep)
            # –î–æ–±–∞–≤–ª—è–µ–º partial –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ analysis_summary –≤ –ø—Ä–æ–º–ø—Ç
            prompt_report = prompt_report.partial(analysis_summary=st.session_state["analysis_summary"])
            chain_report = LLMChain(llm=llm_analyst, prompt=prompt_report, output_key="final_report")
            try:
                # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º —Ü–µ–ø–æ—á–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç ---
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º invoke, –∫–∞–∫ –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö, –∏ –ø–µ—Ä–µ–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å
                result_report = chain_report.invoke({}) # –í—ã–ø–æ–ª–Ω—è–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
                # –ü–æ–ª—É—á–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                raw_final_report = result_report.get("final_report", "–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º numpy —Ç–∏–ø—ã, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
                final_report_content = convert_numpy_types(raw_final_report)
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –≤ st.session_state
                st.session_state["final_report"] = final_report_content
                # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

                # --- –ù–û–í–û–ï: –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –æ—Ç—á–µ—Ç –µ—Å—Ç—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –≤ —Ñ–∞–π–ª—ã ---
                # –ü–æ–ª—É—á–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                output_dir = st.session_state.get("output_dir", ".") # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ output_dir —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                final_report_filename_base = "final_report"
                final_report_txt_path = os.path.join(output_dir, f"{final_report_filename_base}.txt")
                final_report_docx_path = os.path.join(output_dir, f"{final_report_filename_base}.docx")

                # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                # final_report_content —É–∂–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤—ã—à–µ
                if not isinstance(final_report_content, str):
                    final_report_content_to_save = str(final_report_content)
                else:
                    final_report_content_to_save = final_report_content

                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ .txt
                try:
                    with open(final_report_txt_path, "w", encoding="utf-8") as f_txt:
                        f_txt.write(final_report_content_to_save)
                    logger.info(f"–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ TXT: {final_report_txt_path}")
                    st.success(f"‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ TXT: {final_report_txt_path}")
                except Exception as e_txt:
                    error_msg_txt = f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –≤ TXT: {e_txt}"
                    logger.error(error_msg_txt)
                    st.error(error_msg_txt)

                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ .docx
                try:
                    from docx import Document # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ try
                    doc = Document()
                    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    doc.add_heading('–ò—Ç–æ–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç', level=1)
                    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á–µ—Ç–∞ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
                    for line in final_report_content_to_save.splitlines():
                        if line.strip():
                            doc.add_paragraph(line)
                    doc.save(final_report_docx_path)
                    logger.info(f"–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ DOCX: {final_report_docx_path}")
                    st.success(f"‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ DOCX: {final_report_docx_path}")
                except ImportError as e_import:
                    error_msg_import = f"‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ python-docx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –≤ DOCX –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {e_import}"
                    logger.error(error_msg_import)
                    st.error(error_msg_import)
                except Exception as e_docx:
                    error_msg_docx = f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –≤ DOCX: {e_docx}"
                    logger.error(error_msg_docx)
                    st.error(error_msg_docx)

                # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                st.success("‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.")

            except Exception as e: # –≠—Ç–æ—Ç except –ª–æ–≤–∏—Ç –æ—à–∏–±–∫–∏, –≤–æ–∑–Ω–∏–∫–∞—é—â–∏–µ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ –∏–ª–∏ –µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                error_msg = f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞: {e}"
                logger.error(error_msg, exc_info=True) # –î–æ–±–∞–≤–ª—è–µ–º exc_info –¥–ª—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ª–æ–≥–∞
                st.session_state["final_report"] = error_msg # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                st.error(error_msg) # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

        # --- –ë–õ–û–ö –°–û–•–†–ê–ù–ï–ù–ò–Ø –í report.txt –£–î–ê–õ–ï–ù, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –¥—É–±–ª–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã—à–µ ---
        # (–£–¥–∞–ª–∏—Ç–µ –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –±–ª–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è report.txt –∑–¥–µ—Å—å)
        # try:
        #     report_path = os.path.join(output_dir, "report.txt")
        #     report_content_to_save = st.session_state["final_report"] # <-- –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –≤—ã–∑—ã–≤–∞–ª–∞ –æ—à–∏–±–∫—É
        #     if not isinstance(report_content_to_save, str):
        #          report_content_to_save = str(convert_numpy_types(report_content_to_save))
        #     with open(report_path, "w", encoding="utf-8") as f:
        #         f.write(report_content_to_save)
        #     st.session_state["report_path"] = report_path
        #     st.success("‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.")
        # except Exception as e:
        #     st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞: {e}")

# -----------------------------------------
# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
# -----------------------------------------
st.header("4. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞")
if "final_report" in st.session_state:
    with st.expander("üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (–∞–Ω–∞–ª–∏–∑ LLM)"):
        st.text(st.session_state.get("data_structure", "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"))
    with st.expander("üìè –ü–ª–∞–Ω –º–µ—Ç—Ä–∏–∫ (JSON)"):
        st.code(st.session_state.get("metrics_plan", "{}"), language="json")
    with st.expander("üíª –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞"):
        st.code(st.session_state.get("calculation_code", "# –ö–æ–¥ –Ω–µ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω."), language="python")
    st.write("#### üìà –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:")
    st.code(st.session_state.get("metrics_results_raw", "–ù–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ"), language="text")
    with st.expander("üîç –ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫"):
        analysis_summary_to_display = st.session_state.get("analysis_summary", "–ê–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω.")
        if not isinstance(analysis_summary_to_display, str):
            analysis_summary_to_display = str(convert_numpy_types(analysis_summary_to_display))
        st.write(analysis_summary_to_display)
    with st.expander("üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏"):
        st.code(st.session_state.get("viz_code", "# –ö–æ–¥ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"), language="python")
    st.write("#### üìÑ –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç:")
    report_to_display = st.session_state["final_report"]
    if not isinstance(report_to_display, str):
        report_to_display = str(convert_numpy_types(report_to_display))
    st.text_area("", report_to_display, height=400)
    # # –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞
    # report_bytes = BytesIO(report_to_display.encode("utf-8"))
    # st.download_button(
    #     label="üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç (txt)",
    #     data=report_bytes,
    #     file_name="report.txt",
    #     mime="text/plain"
    # )
    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    st.write("#### üìä –ì—Ä–∞—Ñ–∏–∫–∏:")
    try:
        output_dir = st.session_state.get("output_dir", ".")
        plot_files = [f for f in os.listdir(output_dir) if f.startswith("plot_") and f.endswith(".png")]
        if plot_files:
            cols = st.columns(2)
            for i, plot in enumerate(plot_files):
                with cols[i % 2]:
                    st.image(os.path.join(output_dir, plot), caption=plot, use_container_width=True)
        else:
            st.info("–ì—Ä–∞—Ñ–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.")
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤: {e}")
